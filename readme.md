# ISW Service - Interswitch Payment Switch

A TypeScript-based Interswitch payment switch service that processes POS card transactions via Interswitch and UPSL switches.

---

## Quick Start - Automated CI/CD

This service is fully automated with GitHub Actions CI/CD pipeline deploying to AWS EKS.

### Architecture Overview

```
┌─────────────────┐     ┌──────────────┐     ┌─────────────────┐
│   GitHub Repo   │────▶│GitHub Actions│────▶│    AWS ECR      │
│  (push to main/ │     │  (CI/CD)     │     │ (Docker Images) │
│   develop)      │     └──────────────┘     └────────┬────────┘
└─────────────────┘                                   │
                                                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                        AWS EKS Cluster                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐ │
│  │ development │  │   staging   │  │      production         │ │
│  │  namespace  │  │  namespace  │  │       namespace         │ │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘ │
│         │                │                      │               │
│         └────────────────┼──────────────────────┘               │
│                          ▼                                      │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  isw-service Pod                         │   │
│  │  ┌──────────────┐  ┌───────────────────┐                │   │
│  │  │Express :4000 │  │Plain Socket :5000 │                │   │
│  │  │  (HTTP API)  │  │  (POS Terminals)  │                │   │
│  │  └──────────────┘  └───────────────────┘                │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
         │              │
         ▼              ▼
┌──────────────┐ ┌────────────┐
│   MongoDB    │ │   Redis    │
│  (external)  │ │(ElastiCache)│
└──────────────┘ └────────────┘
         │
         ▼
┌─────────────────┐
│  Switch APIs    │
│(Interswitch/UPSL)│
└─────────────────┘
```

### Deployment Flow

1. **Push to `develop` branch** → Deploys to `development` namespace
2. **Push to `main` branch** → Deploys to `production` namespace
3. **Manual workflow dispatch** → Choose any environment (development/staging/production)

### What Happens on Deploy

```
1. GitHub Actions triggered on push
        │
        ▼
2. Build Docker image with multi-stage Dockerfile
        │
        ▼
3. Push to AWS ECR (178309657334.dkr.ecr.us-east-1.amazonaws.com/isw-service)
        │
        ▼
4. Run Trivy security scan
        │
        ▼
5. Update kubeconfig for EKS cluster
        │
        ▼
6. kubectl set image → Rolling update deployment
        │
        ▼
7. Verify deployment health
```

---

## Secrets Management

All secrets are stored in **Kubernetes Secrets** (not in the repo or GitHub Secrets):

### Application Secrets
```bash
# Secret: isw-service-secrets
kubectl get secret isw-service-secrets -n production -o yaml
```

Contains:
- Redis credentials (REDIS_HOST, REDIS_PASSWORD)
- MongoDB connection string (DB)
- Interswitch keys (ISW_COMPONENT_KEY1/2/3, ZMK_ENC)
- Interswitch connection details (ISW_IP, ISW_PORT)
- Settlement account details
- All other environment variables

---

## Environment Configuration

The service uses a layered configuration:

1. **Base defaults** - `src/pre-start/env/production.env` (non-sensitive only)
2. **Runtime overrides** - K8s secrets injected via `envFrom`

### production.env (safe to commit)
```env
NODE_ENV=production
PORT=4000
SOCKET_SERVER_PORT_PLAIN=5000
SOCKET_SERVER_IP=0.0.0.0
# All sensitive values injected from K8s secrets
```

---

## Service Endpoints

### Internal (ClusterIP)
- **HTTP API**: `isw-service:4000`
- **Plain Socket**: `isw-service:5000`

### External (LoadBalancer - NLB)
| Environment | Endpoint |
|-------------|----------|
| Development | `<auto-generated>.elb.us-east-1.amazonaws.com:5000` |
| Staging | `<auto-generated>.elb.us-east-1.amazonaws.com:5000` |
| Production | `<auto-generated>.elb.us-east-1.amazonaws.com:5000` |

---

## Monitoring Commands

### Check Health
```bash
# Via kubectl exec
kubectl exec -n production deployment/isw-service -- wget -qO- localhost:4000/health

# Response:
# {"status":"healthy","service":"isw-service","timestamp":"...","uptime":123.45}
```

### View Logs
```bash
# Real-time logs
kubectl logs -f -n production deployment/isw-service

# Filter Interswitch logs
kubectl logs -n production deployment/isw-service | grep -i interswitch

# Filter errors
kubectl logs -n production deployment/isw-service | grep -i error
```

### Check Pod Status
```bash
kubectl get pods -n production -l app=isw-service
kubectl describe pod -n production -l app=isw-service
```

### Verify Secrets
```bash
# Check env vars in running pod
kubectl exec -n production deployment/isw-service -- node -e "
console.log('REDIS_HOST:', process.env.REDIS_HOST);
console.log('ISW_IP:', process.env.ISW_IP);
console.log('ISW_PORT:', process.env.ISW_PORT);
"
```

---

## Manual Deployment

### Trigger GitHub Actions
```bash
# Via GitHub CLI
gh workflow run deploy.yml -f environment=staging

# Watch the run
gh run watch
```

### Direct kubectl (emergency)
```bash
# Get latest image tag
aws ecr describe-images --repository-name isw-service \
  --query 'imageDetails[*].imageTags' --output json | jq -r '.[][] | select(startswith("2025"))' | sort -r | head -1

# Update deployment
kubectl set image deployment/isw-service \
  isw-service=178309657334.dkr.ecr.us-east-1.amazonaws.com/isw-service:<TAG> \
  -n production

# Watch rollout
kubectl rollout status deployment/isw-service -n production
```

---

## Important Notes

### Replicas Must Be 1
The Socket Server cannot scale horizontally. The K8s deployment is configured with `replicas: 1`. Do not increase this.

### Interswitch Configuration
The service connects to Interswitch via plain socket on port 5000 (configurable via SOCKET_SERVER_PORT_PLAIN).

---

## File Structure

```
isw-service/
├── .github/
│   └── workflows/
│       └── deploy.yml          # CI/CD pipeline
├── k8s/
│   └── deployment.yaml         # K8s Deployment + Services
├── src/
│   ├── pre-start/
│   │   └── env/
│   │       └── production.env  # Non-sensitive defaults
│   ├── socket/
│   │   ├── deploySocketService.ts
│   │   ├── socketServer.ts
│   │   ├── socketServerHandler.ts
│   │   ├── socketClient_ISW.ts
│   │   └── socketClient_UPSL.ts
│   ├── controller/
│   │   └── switchHandlers/
│   │       ├── Interswitch.ts
│   │       └── Upsl.ts
│   ├── Server.ts               # Express + health endpoint
│   └── index.ts                # Entry point
├── Dockerfile                  # Multi-stage build
├── .dockerignore
└── README.md
```

---

## Updating Secrets

To update secrets (run from k8s-secrets directory):
```bash
cd /path/to/k8s-secrets

# Edit apply-secrets.sh with new values
# Then run:
./apply-secrets.sh production
```

Or manually:
```bash
kubectl create secret generic isw-service-secrets \
  --from-literal=ISW_IP=... \
  --from-literal=ISW_PORT=... \
  # ... all keys
  --namespace=production \
  --dry-run=client -o yaml | kubectl apply -f -
```

---

## Troubleshooting

### Pod CrashLoopBackOff
```bash
kubectl logs -n production deployment/isw-service --previous
kubectl describe pod -n production -l app=isw-service
```

### Interswitch Connection Failed
- Verify ISW_IP and ISW_PORT are correct
- Check network connectivity to Interswitch
- Verify encryption keys (ZMK_ENC, ISW_COMPONENT_KEY1/2/3)

### Redis Connection Failed
- Check REDIS_HOST points to ElastiCache endpoint
- Verify security groups allow access from EKS

---

## Required Environment Variables

### Core Application Variables

| Variable | Description | Required | Example/Default |
|----------|-------------|----------|-----------------|
| `NODE_ENV` | Application environment | Yes | `production` |
| `PORT` | HTTP server port | No | `4000` |
| `HOST` | Application host | No | `0.0.0.0` |

### Redis Configuration

| Variable | Description | Required | Example/Default |
|----------|-------------|----------|-----------------|
| `REDIS_HOST` | Redis server hostname | Yes | ElastiCache endpoint |
| `REDIS_PORT` | Redis server port | No | `6379` |
| `REDIS_PASSWORD` | Redis authentication password | Yes | Auth token |

### Socket Server Configuration

| Variable | Description | Required | Example/Default |
|----------|-------------|----------|-----------------|
| `SOCKET_SERVER_IP` | Socket server bind IP | Yes | `0.0.0.0` |
| `SOCKET_SERVER_PORT_PLAIN` | Plain socket port | Yes | `5000` |

### Interswitch Configuration

| Variable | Description | Required | Example |
|----------|-------------|----------|---------|
| `ISW_IP` | Interswitch server IP | Yes | `172.25.0.1` |
| `ISW_PORT` | Interswitch server port | Yes | `51348` |
| `ZMK_ENC` | Zone Master Key (encrypted, hex) | Yes | `518019A1CE432015...` |
| `PWK_ENC_PROD` | PIN Working Key (production) | Yes | Team provided |
| `PWK_ENC_TEST` | PIN Working Key (test) | No | Team provided |
| `ISW_COMPONENT_KEY1` | Interswitch component key 1 | Yes | `CDDA7AB9F1DF2926...` |
| `ISW_COMPONENT_KEY2` | Interswitch component key 2 | Yes | `A11C43AD348C9E4C...` |
| `ISW_COMPONENT_KEY3` | Interswitch component key 3 | Yes | `3D4620B50B10977F...` |
| `INTERSWITCH_SETTLEMENT_ACCOUNT` | Settlement account number | Yes | `1771444108` |

### Logging Configuration

| Variable | Description | Required | Example/Default |
|----------|-------------|----------|-----------------|
| `JET_LOGGER_MODE` | Logging mode | No | `CONSOLE` |
| `JET_LOGGER_TIMESTAMP` | Include timestamps | No | `TRUE` |
| `JET_LOGGER_FORMAT` | Log format | No | `LINE` |

---

## Version History

- **v1.0.0** - Initial Kubernetes deployment with automated CI/CD

---

**Repository**: [isw-service](https://github.com/cbi-technologies-cams/isw-service)
**Maintainer**: CBI Technologies
